{% verbatim %}
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BitoPro網格交易系統</title>
  <!-- Vuetify CSS -->
  <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
  <!-- Material Design Icons -->
  <link href="https://fonts.googleapis.com/css?family=Material+Icons" rel="stylesheet">
  <!-- Vue -->
  <script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
  <!-- Vuetify JS -->
  <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
  <style>
    body {
      background: #f5f5f5;
    }
    .card-title {
      font-weight: bold;
      font-size: 20px;
    }
  </style>
</head>
<body>
  <div id="app">
    <v-app>
      <!-- App Bar -->
      <v-app-bar app color="primary" dark>
        <v-toolbar-title>BitoPro網格交易系統</v-toolbar-title>
      </v-app-bar>
      
      <!-- 主內容 -->
      <v-main>
        <v-container fluid class="mt-5">
          <v-row>
            <!-- 交易操作區 -->
            <v-col cols="12" md="6">
              <v-card elevation="2" class="pa-4">
                <v-card-title class="card-title">交易操作</v-card-title>
                <v-divider class="mb-4"></v-divider>
                <v-card-text>
                  <v-form>
                    <v-select
                      :items="symbols"
                      label="選擇幣種"
                      v-model="form.symbol"
                      :disabled="trading"
                      required
                    ></v-select>
                    <v-text-field
                      label="下單數量"
                      v-model.number="form.order_size"
                      type="number"
                      required
                    ></v-text-field>
                    <v-text-field
                      label="漲幅百分比 (%)"
                      v-model.number="form.price_up_percentage"
                      type="number"
                      required
                    ></v-text-field>
                    <v-text-field
                      label="跌幅百分比 (%)"
                      v-model.number="form.price_down_percentage"
                      type="number"
                      required
                    ></v-text-field>
                  </v-form>
                  <v-divider class="my-4"></v-divider>
                  <v-row>
                    <v-col cols="12" sm="4">
                      <v-btn
                        color="success"
                        block
                        @click="startTrading"
                        :disabled="trading"
                      >開始交易</v-btn>
                    </v-col>
                    <v-col cols="12" sm="4">
                      <v-btn
                        color="warning"
                        block
                        @click="updateParams"
                        :disabled="!trading"
                      >更新參數</v-btn>
                    </v-col>
                    <v-col cols="12" sm="4">
                      <v-btn
                        color="error"
                        block
                        @click="stopTrading"
                        :disabled="!trading"
                      >停止交易</v-btn>
                    </v-col>
                  </v-row>
                </v-card-text>
              </v-card>
            </v-col>
            
            <!-- 交易狀態區 -->
            <v-col cols="12" md="6">
              <v-card elevation="2" class="pa-4">
                <v-card-title class="card-title">交易狀態</v-card-title>
                <v-divider class="mb-4"></v-divider>
                <v-card-text>
                  <v-alert type="info" dense outlined v-if="trading && status && Object.keys(status).length">
                    <div><strong>幣種：</strong>[[ status.pair ]]</div>
                    <div><strong>下單數量：</strong>[[ status.order_size ]]</div>
                    <div><strong>漲幅百分比：</strong>[[ status.price_up_percentage ]]%</div>
                    <div><strong>跌幅百分比：</strong>[[ status.price_down_percentage ]]%</div>
                    <div><strong>開始時間：</strong>[[ status.start_time ]]</div>
                  </v-alert>
                  <v-alert type="warning" dense outlined v-else>
                    目前未在交易
                  </v-alert>
                </v-card-text>
              </v-card>
            </v-col>
          </v-row>
          
          <!-- 帳戶餘額區 -->
          <v-row class="mt-4">
            <v-col cols="12">
              <v-card elevation="2" class="pa-4">
                <v-card-title class="card-title">帳戶餘額</v-card-title>
                <v-divider class="mb-4"></v-divider>
                <v-card-text>
                  <div v-if="balance && balance.length > 0">
                    <div v-for="(item, index) in balance" :key="index">
                      <strong>[[ item.currency.toUpperCase() ]]:</strong> [[ item.available ]]
                    </div>
                  </div>
                  <div v-else>
                    <v-progress-circular indeterminate color="primary"></v-progress-circular>
                  </div>
                </v-card-text>
              </v-card>
            </v-col>
          </v-row>
          
          <!-- 刷新狀態按鈕 -->
          <v-row class="mt-4">
            <v-col cols="12" class="text-center">
              <v-btn color="primary" @click="fetchStatus">刷新狀態</v-btn>
            </v-col>
          </v-row>
        </v-container>
      </v-main>
      
      <!-- Footer -->
      <v-footer app padless color="primary" dark>
        <v-col class="text-center white--text py-3">
          © 2025 BitoPro 網格交易系統
        </v-col>
      </v-footer>
    </v-app>
  </div>
  
  <script>
    new Vue({
      el: '#app',
      vuetify: new Vuetify(),
      delimiters: ['[[', ']]'],
      data: () => ({
        form: {
          symbol: '',
          order_size: 0.01,
          price_up_percentage: 1,
          price_down_percentage: 2
        },
        trading: false,
        status: {},
        symbols: [],
        balance: null
      }),
      methods: {
        async fetchSymbols() {
          try {
            const response = await fetch('/pairs/');
            const data = await response.json();
            // 假設 data 結構中有 data 陣列
            this.symbols = data.data.map(item => item.pair);
            if (!this.form.symbol && this.symbols.length > 0) {
              this.form.symbol = this.symbols[0];
            }
          } catch (error) {
            console.error('載入交易對失敗', error);
          }
        },
        async fetchBalance() {
          try {
            const response = await fetch('/balance/');
            const data = await response.json();
            this.balance = data.data;
          } catch (error) {
            console.error('載入餘額失敗', error);
          }
        },
        async fetchStatus() {
          try {
            const response = await fetch('/check_trade', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({})
            });
            const data = await response.json();
            if (data && data.pair) {
              this.trading = true;
              this.status = data;
            } else {
              this.trading = false;
              this.status = {};
            }
          } catch (error) {
            console.error('載入交易狀態失敗', error);
          }
        },
        async startTrading() {
          try {
            const response = await fetch('/start_trade', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(this.form)
            });
            const data = await response.json();
            if (data.status === '交易機器人成功啟動') {
              this.trading = true;
              this.status = data.data;
            } else {
              alert('啟動失敗：' + (data.message || '未知錯誤'));
            }
          } catch (error) {
            console.error('啟動交易失敗', error);
            alert('啟動交易失敗，請重試');
          }
        },
        async updateParams() {
          if (!this.trading) return;
          try {
            const response = await fetch('/update_trade', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                order_size: this.form.order_size,
                price_up_percentage: this.form.price_up_percentage,
                price_down_percentage: this.form.price_down_percentage
              })
            });
            const data = await response.json();
            if (data.status === '更新成功') {
              this.status = data.data;
              alert('更新成功');
            } else {
              alert('更新失敗：' + (data.message || '未知錯誤'));
            }
          } catch (error) {
            console.error('更新參數失敗', error);
            alert('更新參數失敗，請重試');
          }
        },
        async stopTrading() {
          try {
            const response = await fetch('/stop_trade', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({})
            });
            const data = await response.json();
            if (data.status === '交易機器人已停止') {
              this.trading = false;
              this.status = {};
              alert('交易機器人已停止');
            } else {
              alert('停止失敗：' + (data.message || '未知錯誤'));
            }
          } catch (error) {
            console.error('停止交易失敗', error);
            alert('停止交易失敗，請重試');
          }
        }
      },
      mounted() {
        this.fetchSymbols();
        this.fetchBalance();
        this.fetchStatus();
      }
    });
  </script>
</body>
</html>
{% endverbatim %}
